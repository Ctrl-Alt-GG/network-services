---
- name: Verify DNS
  hosts: all
  become: true
  gather_facts: false
  tasks:
    - name: Verify Unbound package is installed
      package:
        name: unbound
        state: present
      check_mode: true
      register: unbound_installed
      failed_when: unbound_installed is changed

    - name: Verify Unbound configuration directories exist
      stat:
        path: "{{ item }}"
      register: unbound_dirs
      failed_when: not unbound_dirs.stat.exists or not unbound_dirs.stat.isdir
      loop:
        - /etc/unbound
        - /etc/unbound/conf.d
        - /var/lib/unbound

    - name: Verify DNSSEC root trust anchor exists
      stat:
        path: /var/lib/unbound/root.key
      register: dnssec_anchor
      failed_when: not dnssec_anchor.stat.exists

    - name: Verify unbound.conf exists and is valid
      stat:
        path: /etc/unbound/unbound.conf
      register: unbound_config
      failed_when: not unbound_config.stat.exists

    - name: Validate unbound configuration syntax
      command: unbound-checkconf /etc/unbound/unbound.conf
      register: unbound_syntax_check
      failed_when: unbound_syntax_check.rc != 0

    - name: Verify Unbound service is enabled and running
      service:
        name: unbound
        state: started
        enabled: true
      check_mode: true
      register: unbound_service
      failed_when: unbound_service is changed

    - name: Verify DNS is allowed in firewalld
      command: firewall-cmd --list-services
      register: firewall_services
      failed_when: "'dns' not in firewall_services.stdout"

    - name: Test DNS resolution functionality
      command: dig @127.0.0.1 google.com
      register: dns_test
      failed_when: dns_test.rc != 0
      ignore_errors: true

    - name: Verify Unbound is listening on port 53
      wait_for:
        port: 53
        host: 127.0.0.1
        timeout: 10
...
