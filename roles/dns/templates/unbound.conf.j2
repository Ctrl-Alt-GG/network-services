# {{ansible_managed}}
server:
  interface: 0.0.0.0
  interface: ::0
  do-ip4: yes
  do-ip6: yes
  do-udp: yes
  do-tcp: yes

  module-config: "validator iterator"

  chroot: ""
  pidfile: "/var/run/unbound/unbound.pid"

  # Tuning for performance
  num-threads: 4
  so-reuseport: yes
  msg-cache-size: 1024m
  rrset-cache-size: 2048m
  msg-cache-slabs: 4
  rrset-cache-slabs: 4
  infra-cache-slabs: 4
  key-cache-slabs: 4
  outgoing-range: 8192
  num-queries-per-thread: 4096
  prefetch: yes
  prefetch-key: yes
  rrset-roundrobin: yes
  serve-expired: yes
  serve-expired-ttl: 86400

  # Privacy and hardening
  qname-minimisation: yes
  harden-glue: yes
  harden-dnssec-stripped: yes
  harden-below-nxdomain: yes
  harden-algo-downgrade: yes
  aggressive-nsec: yes
  hide-identity: yes
  hide-version: yes
  hide-trustanchor: yes
  hide-http-user-agent: yes
  minimal-responses: yes
  deny-any: yes
  trust-anchor-signaling: yes
  root-key-sentinel: yes
  val-clean-additional: yes
  val-permissive-mode: no

  # Private address ranges â€” refuse to return RFC1918 from public names
  private-address: 10.0.0.0/8
  private-address: 172.16.0.0/12
  private-address: 192.168.0.0/16
  private-address: 169.254.0.0/16
  private-address: fd00::/8
  private-address: fe80::/10

  # Detect poisoning: log warning if more than threshold unsolicited replies
  unwanted-reply-threshold: 10000

  # Access control
  access-control: 127.0.0.0/8 allow
  access-control: ::1/128 allow
  access-control: 192.168.0.0/16 allow
  access-control: 0.0.0.0/0 refuse
  access-control: ::/0 refuse

  # DNSSEC trust anchor
  auto-trust-anchor-file: "/var/lib/unbound/root.key"

  # Reasonable EDNS size to reduce fragmentation
  edns-buffer-size: 1232
  max-udp-size: 1232

  # Logging (set verbosity to 2 for debugging)
  verbosity: 1
  log-queries: no
  log-replies: no
  log-servfail: yes
  logfile: ""
  use-syslog: yes

  # Include private zone definitions
  include: "/etc/unbound/zones.d/*.conf"

{% if lancache.enabled | default(false) %}
  # Include extra LANcache overrides
  include: "/etc/unbound/lancache.d/*.conf"
{% endif %}

remote-control:
    control-enable: yes
    control-interface: 127.0.0.1
    control-interface: ::1
    control-port: 8953
    server-key-file: "/etc/unbound/unbound_server.key"
    server-cert-file: "/etc/unbound/unbound_server.pem"
    control-key-file: "/etc/unbound/unbound_control.key"
    control-cert-file: "/etc/unbound/unbound_control.pem"

# Forward all queries to upstream resolvers
forward-zone:
  name: "."
  forward-first: yes
{% for ip in upstreams %}
  forward-addr: {{ ip }}
{% endfor %}
