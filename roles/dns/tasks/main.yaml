---
# --- Package Installation ---
- name: Install Unbound
  ansible.builtin.package:
    name: unbound
    state: present

# --- Configuration ---
- name: Ensure config directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: unbound
    group: unbound
    mode: "0750"
  loop:
    - /etc/unbound
    - /etc/unbound/conf.d
    - /etc/unbound/zones.d
    - /etc/unbound/lancache.d
    - /var/lib/unbound

- name: Bootstrap DNSSEC root trust anchor if missing
  ansible.builtin.command: >
    unbound-anchor -a /var/lib/unbound/root.key
  args:
    creates: /var/lib/unbound/root.key
  notify: Restart unbound

- name: Ensure correct ownership and permissions of the trust anchor
  ansible.builtin.file:
    path: /var/lib/unbound/root.key
    owner: unbound
    group: unbound
    mode: '0640'
    state: file

- name: Deploy unbound.conf
  ansible.builtin.template:
    src: unbound.conf.j2
    dest: /etc/unbound/unbound.conf
    owner: root
    group: root
    mode: '0644'
    validate: 'unbound-checkconf %s'
  notify: Restart unbound

# --- Private Zones ---
- name: Deploy private zone configurations
  ansible.builtin.template:
    src: unbound-zone.conf.j2
    dest: "/etc/unbound/zones.d/{{ zone.name }}.conf"
    owner: root
    group: unbound
    mode: '0640'
    validate: 'unbound-checkconf %s'
  loop: "{{ private_zones | default([]) }}"
  loop_control:
    loop_var: zone
  notify: Restart unbound
  when: private_zones | default([]) | length > 0

- name: List deployed zone files
  ansible.builtin.find:
    paths: /etc/unbound/zones.d
    patterns: '*.conf'
  register: deployed_zone_files

- name: Remove stale zone files
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ deployed_zone_files.files }}"
  when: (item.path | basename | regex_replace('\\.conf$', '')) not in (private_zones | default([]) | map(attribute='name') | list)
  notify: Restart unbound

# --- LANcache Integration ---
- name: Install Git
  ansible.builtin.dnf:
    name: git
    state: present
  when: lancache.enabled | default(false)

- name: Clone uklans/cache-domains
  ansible.builtin.git:
    repo: "{{ cache_domains_repo }}"
    dest: /var/lib/unbound/cache-domains
    version: "{{ cache_domains_branch }}"
    update: true
    force: true
    depth: 1
  register: git_clone_result
  retries: 3
  delay: 10
  when: lancache.enabled | default(false)
  become: true
  become_user: unbound

- name: Find cache domain files
  ansible.builtin.find:
    paths: /var/lib/unbound/cache-domains
    patterns: "*.txt"
    recurse: true
  register: cache_domain_files
  when: lancache.enabled | default(false)

- name: Read and process cache domain files
  ansible.builtin.shell: |
    set -o pipefail
    awk '!/^(#|$)/ {print tolower($0)}' {{ item.path }} | sed 's/[[:space:]]\+$//'
  register: domain_contents
  loop: "{{ cache_domain_files.files }}"
  when: lancache.enabled | default(false)
  changed_when: false

- name: Create unified domain list
  ansible.builtin.set_fact:
    cache_domains_list: "{{ domain_contents.results | map(attribute='stdout_lines') | list | flatten | unique | sort }}"
  when: lancache.enabled | default(false)

- name: Render LANcache redirect overrides
  ansible.builtin.template:
    src: lancache-redirect.conf.j2
    dest: /etc/unbound/lancache.d/override.conf
    owner: root
    group: unbound
    mode: "0640"
  vars:
    lancache_domains: "{{ cache_domains_list }}"
  notify: Reload unbound
  when: lancache.enabled | default(false)

# --- SELinux ---
- name: Install required SELinux packages
  ansible.builtin.dnf:
    name:
      - selinux-policy-targeted
      - policycoreutils-python-utils
    state: present
  when: ansible_selinux.status == 'enabled'

# --- Firewall ---
- name: Allow DNS through firewall
  ansible.posix.firewalld:
    service: dns
    state: enabled
    permanent: true
    immediate: true

# --- Audit Rules ---
- name: Add DNS audit rules
  ansible.builtin.blockinfile:
    path: /etc/audit/rules.d/dns.rules
    create: true
    mode: '0640'
    block: |
      -w /etc/unbound/ -p wa -k dns_config
      -w /var/lib/unbound/ -p wa -k dns_data
      -a always,exit -F arch=b64 -S connect -F a2=16 -F success=1 -k dns_queries
  notify: Restart auditd

# --- Enable Services ---
- name: Enable and start Unbound
  ansible.builtin.systemd:
    name: unbound
    state: started
    enabled: true
...
