---
- name: Verify DHCP
  hosts: all
  become: true
  gather_facts: false
  tasks:
    - name: Verify Kea DHCP package is installed
      package:
        name: kea
        state: present
      check_mode: true
      register: kea_installed
      failed_when: kea_installed is changed

    - name: Verify Kea config directory exists with correct permissions
      stat:
        path: /etc/kea
      register: kea_config_dir
      failed_when: >
        not kea_config_dir.stat.exists or
        kea_config_dir.stat.mode != '0750' or
        kea_config_dir.stat.gr_name != 'kea'

    - name: Verify Kea log directory exists with correct permissions
      stat:
        path: /var/log/kea
      register: kea_log_dir
      failed_when: >
        not kea_log_dir.stat.exists or
        kea_log_dir.stat.mode != '0750' or
        kea_log_dir.stat.pw_name != 'kea'

    - name: Verify kea-dhcp4.conf exists and is valid JSON
      stat:
        path: /etc/kea/kea-dhcp4.conf
      register: kea_dhcp4_config
      failed_when: not kea_dhcp4_config.stat.exists

    - name: Validate kea-dhcp4.conf JSON syntax
      command: jq . /etc/kea/kea-dhcp4.conf
      register: kea_json_validation
      changed_when: false
      failed_when: kea_json_validation.rc != 0

    - name: Verify kea-ctrl-agent.conf exists
      stat:
        path: /etc/kea/kea-ctrl-agent.conf
      register: kea_ctrl_config
      failed_when: not kea_ctrl_config.stat.exists

    - name: Verify kea-dhcp4 service is enabled and running
      service:
        name: kea-dhcp4
        state: started
        enabled: true
      check_mode: true
      register: kea_dhcp4_service
      failed_when: kea_dhcp4_service is changed

    - name: Verify kea-ctrl-agent service is enabled and running
      service:
        name: kea-ctrl-agent
        state: started
        enabled: true
      check_mode: true
      register: kea_ctrl_service
      failed_when: kea_ctrl_service is changed

    - name: Verify DHCP is allowed in firewalld
      command: firewall-cmd --list-services
      register: firewall_services
      changed_when: false
      failed_when: "'dhcp' not in firewall_services.stdout"

    - name: Check Kea DHCP server is listening on port 67
      wait_for:
        port: 67
        proto: udp
        timeout: 10
      ignore_errors: true
      register: dhcp_port_check
...
