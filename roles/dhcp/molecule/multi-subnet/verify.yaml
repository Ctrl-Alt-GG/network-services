---
- name: Verify Multi-Subnet DHCP
  hosts: all
  become: true
  gather_facts: false
  vars:
    expected_subnets:
      - "192.168.1.0/24"
      - "10.0.1.0/24"
      - "172.16.1.0/24"
  tasks:
    - name: Read Kea DHCP configuration
      slurp:
        src: /etc/kea/kea-dhcp4.conf
      register: kea_config_raw

    - name: Parse Kea configuration
      set_fact:
        kea_config: "{{ kea_config_raw.content | b64decode | from_json }}"

    - name: Verify multiple subnets are configured
      assert:
        that:
          - kea_config.Dhcp4.subnet4 | length >= 3
          - "item in (kea_config.Dhcp4.subnet4 | map(attribute='subnet') | list)"
        fail_msg: "Expected subnet {{ item }} not found in configuration"
      loop: "{{ expected_subnets }}"

    - name: Verify subnet ranges are configured
      assert:
        that:
          - item.pools is defined
          - item.pools | length > 0
        fail_msg: "Subnet {{ item.subnet }} missing pool configuration"
      loop: "{{ kea_config.Dhcp4.subnet4 }}"
...
