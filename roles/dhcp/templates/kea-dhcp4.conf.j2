# {{ansible_managed}}
{
  "Dhcp4": {
    "interfaces-config": {
      "interfaces": [
{% for ifname in interfaces %}
        "{{ ifname }}"{% if not loop.last %},{% endif %}
{% endfor %}
      ],
      "dhcp-socket-type": "udp"
    },

    "control-socket": {
      "socket-type": "unix",
      "socket-name": "/run/kea/kea4-ctrl-socket"
    },

    "lease-database": {
      "type": "memfile",
      "name": "/var/lib/kea/kea-leases4.csv",
      "lfc-interval": 3600
    },

    "valid-lifetime": 3600,
    "renew-timer": 900,
    "rebind-timer": 1800,

    "option-data": [
{% if dns_servers | default([]) | length > 0 %}
      { "name": "domain-name-servers", "data": "{{ dns_servers | join(', ') }}" }{% if ntp_servers | default([]) | length > 0 %},{% endif %}
{% endif %}
{% if ntp_servers | default([]) | length > 0 %}
      { "name": "ntp-servers", "data": "{{ ntp_servers | join(', ') }}" }
{% endif %}
    ],

    "subnet4": [
{% for s in subnets %}
{%   set router = (s | ansible.utils.ipaddr('last_usable')) %}
{%   set pool_start = (s | ansible.utils.nthhost(1)) %}
{%   set pool_end = (router | ansible.utils.ipmath(-1)) %}
      {
        "id": {{ loop.index }},
        "subnet": "{{ s }}",
        "relay": { "ip-addresses": [ "{{ router }}" ] },
        "pools": [
          { "pool": "{{ pool_start }} - {{ pool_end }}" }
        ],
        "option-data": [
          { "name": "routers", "data": "{{ router }}" }
        ]
      }{% if not loop.last %},{% endif %}
{% endfor %}
    ],

    "loggers": [
      {
        "name": "kea-dhcp4",
        "output-options": [ { "output": "/var/log/kea/kea-dhcp4.log" } ],
        "severity": "INFO",
        "debuglevel": 0
      }
    ]
  }
}
