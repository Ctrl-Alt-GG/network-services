---
# ── PHP Repository ────────────────────────────────────────────
- name: Install Remi repository
  ansible.builtin.dnf:
    name: "https://rpms.remirepo.net/enterprise/remi-release-{{ ansible_distribution_major_version }}.rpm"
    state: present
    disable_gpg_check: true

- name: Reset PHP module stream
  ansible.builtin.command:
    cmd: dnf module reset php -y
  register: php_module_reset
  changed_when: "'Nothing to do' not in php_module_reset.stdout"

- name: Enable PHP {{ librenms_php_version }} from Remi
  ansible.builtin.command:
    cmd: "dnf module enable php:remi-{{ librenms_php_version }} -y"
  register: php_module_enable
  changed_when: "'Nothing to do' not in php_module_enable.stdout"

# ── Package Installation ──────────────────────────────────────
- name: Install LibreNMS dependencies
  ansible.builtin.dnf:
    name:
      - nginx
      - mariadb-server
      - php-cli
      - php-common
      - php-curl
      - php-fpm
      - php-gd
      - php-gmp
      - php-mbstring
      - php-mysqlnd
      - php-opcache
      - php-pdo
      - php-process
      - php-snmp
      - php-xml
      - php-zip
      - php-pecl-imagick
      - ImageMagick
      - net-snmp
      - net-snmp-utils
      - git
      - cronie
      - acl
      - fping
      - python3-PyMySQL
      - unzip
      - rrdtool
    state: present

# ── User Setup ────────────────────────────────────────────────
- name: Ensure librenms group exists
  ansible.builtin.group:
    name: "{{ librenms_group }}"
    system: true
    state: present

- name: Create librenms system user
  ansible.builtin.user:
    name: "{{ librenms_user }}"
    home: "{{ librenms_install_dir }}"
    group: "{{ librenms_group }}"
    shell: /bin/bash
    system: true
    create_home: false
    state: present

- name: Add nginx user to librenms group
  ansible.builtin.user:
    name: nginx
    groups: "{{ librenms_group }}"
    append: true

# ── Application Clone & Composer ──────────────────────────────
- name: Check for existing destination directory
  ansible.builtin.stat:
    path: "{{ librenms_install_dir }}"
  register: librenms_install_dir_stat

- name: Check if existing destination is a git repo
  ansible.builtin.stat:
    path: "{{ librenms_install_dir }}/.git"
  when: librenms_install_dir_stat.stat.exists
  register: lib_git_stat

- name: Delete non-git existing directory
  ansible.builtin.command:
    cmd: rm -rf "{{ librenms_install_dir }}"
  when: librenms_install_dir_stat.stat.exists and not lib_git_stat.stat.exists
  args:
    removes: "{{ librenms_install_dir }}"

- name: Clone librenms if not present
  ansible.builtin.git:
    repo: "{{ librenms_repo }}"
    dest: "{{ librenms_install_dir }}"
    version: "{{ librenms_branch }}"
    depth: 1
    accept_hostkey: yes
  register: librenms_clone
  when: not librenms_install_dir_stat.stat.exists or (librenms_install_dir_stat.stat.exists and not lib_git_stat.stat.exists)

- name: Update existing librenms git checkout
  ansible.builtin.git:
    repo: "{{ librenms_repo }}"
    dest: "{{ librenms_install_dir }}"
    version: "{{ librenms_branch }}"
    depth: 1
    update: yes
    force: yes
    accept_hostkey: yes
  register: librenms_clone
  when: librenms_install_dir_stat.stat.exists and lib_git_stat.stat.exists

- name: Set LibreNMS directory ownership
  ansible.builtin.file:
    path: "{{ librenms_install_dir }}"
    owner: "{{ librenms_user }}"
    group: "{{ librenms_group }}"
    recurse: true

- name: Install PHP Composer dependencies
  ansible.builtin.command:
    cmd: ./scripts/composer_wrapper.php install --no-dev --no-interaction
    chdir: "{{ librenms_install_dir }}"
  become: true
  become_user: "{{ librenms_user }}"
  register: composer_result
  changed_when: "'Nothing to install' not in composer_result.stderr"

- name: Set ACL permissions on writable directories
  ansible.posix.acl:
    path: "{{ librenms_install_dir }}/{{ item }}"
    entity: "{{ librenms_group }}"
    etype: group
    permissions: rwx
    default: true
    recursive: true
    state: present
  loop:
    - rrd
    - logs
    - bootstrap/cache
    - storage

# ── MariaDB Setup ─────────────────────────────────────────────
- name: Deploy MariaDB configuration for LibreNMS
  ansible.builtin.template:
    src: librenms-mariadb.cnf.j2
    dest: /etc/my.cnf.d/librenms.cnf
    owner: root
    group: root
    mode: '0644'
  notify: Restart mariadb

- name: Enable and start MariaDB
  ansible.builtin.systemd:
    name: mariadb
    enabled: true
    state: started

- name: Create LibreNMS database
  community.mysql.mysql_db:
    name: "{{ librenms_db_name }}"
    encoding: utf8mb4
    collation: utf8mb4_unicode_ci
    state: present
    login_unix_socket: /var/lib/mysql/mysql.sock

- name: Create LibreNMS database user
  community.mysql.mysql_user:
    name: "{{ librenms_db_user }}"
    password: "{{ librenms_db_password }}"
    priv: "{{ librenms_db_name }}.*:ALL"
    host: localhost
    state: present
    login_unix_socket: /var/lib/mysql/mysql.sock
  no_log: true

# ── LibreNMS Configuration ────────────────────────────────────
- name: Check for existing .env file
  ansible.builtin.stat:
    path: "{{ librenms_install_dir }}/.env"
  register: env_file_stat

- name: Read existing APP_KEY
  ansible.builtin.shell:
    cmd: "grep '^APP_KEY=' {{ librenms_install_dir }}/.env | cut -d= -f2-"
    executable: /bin/bash
  register: existing_app_key
  when: env_file_stat.stat.exists
  changed_when: false
  failed_when: false

- name: Deploy LibreNMS .env configuration
  ansible.builtin.template:
    src: librenms-env.j2
    dest: "{{ librenms_install_dir }}/.env"
    owner: "{{ librenms_user }}"
    group: "{{ librenms_group }}"
    mode: '0640'
  vars:
    _app_key: "{{ existing_app_key.stdout | default('') }}"

- name: Generate APP_KEY if not set
  ansible.builtin.command:
    cmd: php artisan key:generate --no-interaction --force
    chdir: "{{ librenms_install_dir }}"
  become: true
  become_user: "{{ librenms_user }}"
  when: (existing_app_key.stdout | default('')) | length == 0

- name: Run database migrations
  ansible.builtin.command:
    cmd: php artisan migrate --no-interaction --force
    chdir: "{{ librenms_install_dir }}"
  become: true
  become_user: "{{ librenms_user }}"
  register: migration_result
  changed_when: "'Migrating' in migration_result.stdout"

- name: Create initial admin user
  ansible.builtin.command:
    cmd: >-
      php artisan user:add {{ librenms_admin_user }}
      -p {{ librenms_admin_password }}
      -r admin -e {{ librenms_admin_email | default('admin@localhost') }}
    chdir: "{{ librenms_install_dir }}"
  become: true
  become_user: "{{ librenms_user }}"
  register: admin_result
  failed_when:
    - admin_result.rc != 0
    - "'already' not in (admin_result.stderr | default('') + admin_result.stdout | default(''))"
  changed_when: admin_result.rc == 0
  when: librenms_admin_user is defined and librenms_admin_password is defined
  no_log: true

# ── Web Server ────────────────────────────────────────────────
- name: Remove default Nginx server block
  ansible.builtin.file:
    path: /etc/nginx/conf.d/default.conf
    state: absent
  notify: Restart nginx

- name: Deploy Nginx configuration for LibreNMS
  ansible.builtin.template:
    src: librenms-nginx.conf.j2
    dest: /etc/nginx/conf.d/librenms.conf
    owner: root
    group: root
    mode: '0644'
  notify: Restart nginx

- name: Deploy PHP-FPM pool configuration for LibreNMS
  ansible.builtin.template:
    src: librenms-php-fpm.conf.j2
    dest: /etc/php-fpm.d/librenms.conf
    owner: root
    group: root
    mode: '0644'
  notify: Restart php-fpm

- name: Remove default PHP-FPM pool
  ansible.builtin.file:
    path: /etc/php-fpm.d/www.conf
    state: absent
  notify: Restart php-fpm

# ── SNMP ──────────────────────────────────────────────────────
- name: Deploy SNMP daemon configuration
  ansible.builtin.template:
    src: librenms-snmpd.conf.j2
    dest: /etc/snmp/snmpd.conf
    owner: root
    group: root
    mode: '0600'
  notify: Restart snmpd

- name: Download distro detection script for SNMP
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/librenms/librenms-agent/master/snmp/distro
    dest: /usr/bin/distro
    owner: root
    group: root
    mode: '0755'

# ── Scheduled Tasks ───────────────────────────────────────────
- name: Deploy LibreNMS cron job
  ansible.builtin.copy:
    src: "{{ librenms_install_dir }}/dist/librenms.cron"
    dest: /etc/cron.d/librenms
    remote_src: true
    owner: root
    group: root
    mode: '0644'

- name: Deploy LibreNMS scheduler systemd service
  ansible.builtin.copy:
    src: "{{ librenms_install_dir }}/dist/librenms-scheduler.service"
    dest: /etc/systemd/system/librenms-scheduler.service
    remote_src: true
    owner: root
    group: root
    mode: '0644'
  notify: Systemctl daemon-reload

- name: Deploy LibreNMS scheduler systemd timer
  ansible.builtin.copy:
    src: "{{ librenms_install_dir }}/dist/librenms-scheduler.timer"
    dest: /etc/systemd/system/librenms-scheduler.timer
    remote_src: true
    owner: root
    group: root
    mode: '0644'
  notify: Systemctl daemon-reload

- name: Flush handlers before enabling timer
  ansible.builtin.meta: flush_handlers

- name: Enable LibreNMS scheduler timer
  ansible.builtin.systemd:
    name: librenms-scheduler.timer
    enabled: true
    state: started

# ── SELinux ───────────────────────────────────────────────────
- name: Install SELinux management packages
  ansible.builtin.dnf:
    name:
      - policycoreutils-python-utils
      - selinux-policy-devel
    state: present
  when: ansible_selinux.status == 'enabled'

- name: Set SELinux booleans for LibreNMS
  ansible.posix.seboolean:
    name: "{{ item }}"
    state: true
    persistent: true
  loop:
    - httpd_can_network_connect
    - httpd_can_network_connect_db
    - httpd_setrlimit
    - httpd_unified
    - httpd_execmem
  when: ansible_selinux.status == 'enabled'

- name: Set SELinux file contexts for LibreNMS
  community.general.sefcontext:
    target: "{{ item.target }}"
    setype: "{{ item.setype }}"
    state: present
  loop:
    - target: "{{ librenms_install_dir }}(/.*)?"
      setype: httpd_sys_rw_content_t
    - target: "{{ librenms_install_dir }}/logs(/.*)?"
      setype: httpd_log_t
    - target: "{{ librenms_install_dir }}/rrd(/.*)?"
      setype: httpd_sys_rw_content_t
  notify: Restorecon librenms
  when: ansible_selinux.status == 'enabled'

# ── Security (project conventions) ────────────────────────────
- name: Allow HTTP through firewall
  ansible.posix.firewalld:
    service: http
    state: enabled
    permanent: true
    immediate: true

- name: Allow SNMP through firewall
  ansible.posix.firewalld:
    service: snmp
    state: enabled
    permanent: true
    immediate: true

- name: Add LibreNMS audit rules
  ansible.builtin.blockinfile:
    path: /etc/audit/rules.d/librenms.rules
    create: true
    mode: '0640'
    block: |
      -w {{ librenms_install_dir }}/.env -p wa -k librenms_config
      -w /etc/nginx/conf.d/librenms.conf -p wa -k librenms_nginx
      -w /etc/php-fpm.d/librenms.conf -p wa -k librenms_phpfpm
      -w /etc/snmp/snmpd.conf -p wa -k librenms_snmp
      -w /etc/my.cnf.d/librenms.cnf -p wa -k librenms_mariadb
  notify: Restart auditd

# ── Enable Services ───────────────────────────────────────────
- name: Enable and start Nginx
  ansible.builtin.systemd:
    name: nginx
    enabled: true
    state: started

- name: Enable and start PHP-FPM
  ansible.builtin.systemd:
    name: php-fpm
    enabled: true
    state: started

- name: Enable and start SNMP daemon
  ansible.builtin.systemd:
    name: snmpd
    enabled: true
    state: started
...
