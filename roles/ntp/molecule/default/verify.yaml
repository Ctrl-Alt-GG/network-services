---
- name: Verify NTP
  hosts: all
  become: true
  gather_facts: false
  tasks:
    - name: Verify chrony package is installed
      package:
        name: chrony
        state: present
      check_mode: true
      register: chrony_installed
      failed_when: chrony_installed is changed

    - name: Verify chrony state directories exist with correct ownership
      stat:
        path: "{{ item }}"
      register: chrony_dirs
      failed_when: >
        not chrony_dirs.stat.exists or
        not chrony_dirs.stat.isdir or
        chrony_dirs.stat.pw_name != 'chrony' or
        chrony_dirs.stat.gr_name != 'chrony'
      loop:
        - /var/lib/chrony
        - /var/log/chrony

    - name: Verify chrony.conf exists
      stat:
        path: /etc/chrony.conf
      register: chrony_config
      failed_when: not chrony_config.stat.exists

    - name: Verify chronyd service is enabled and running
      service:
        name: chronyd
        state: started
        enabled: true
      check_mode: true
      register: chronyd_service
      failed_when: chronyd_service is changed

    - name: Verify NTP is allowed in firewalld
      command: firewall-cmd --list-services
      register: firewall_services
      changed_when: false
      failed_when: "'ntp' not in firewall_services.stdout"

    - name: Test NTP functionality
      command: chrony sources
      register: ntp_sources
      failed_when: ntp_sources.rc != 0
      changed_when: false

    - name: Verify chrony is listening on port 123
      wait_for:
        port: 123
        proto: udp
        timeout: 10
...
